name: ğŸ§ª Tests & Build

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]

jobs:
  test-backend:
    name: ğŸ§ª Backend Unit Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./server

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "server/package-lock.json"

      - name: ğŸ“¦ Install backend dependencies
        run: npm ci

      - name: ğŸ§ª Run backend unit tests with coverage
        run: npm run test:coverage:report

      - name: ğŸ“Š Upload backend coverage reports
        uses: codecov/codecov-action@v4
        with:
          directory: ./server/coverage
          flags: backend-unittests
          name: cardoon-backend-coverage
          fail_ci_if_error: false

  test-frontend:
    name: ğŸ§ª Frontend Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./Cardoon

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: "Cardoon/yarn.lock"

      - name: ğŸ“¦ Install frontend dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ§ª Run frontend tests with coverage
        run: yarn test --run --coverage

      - name: ğŸ“Š Upload frontend coverage reports
        uses: codecov/codecov-action@v4
        with:
          directory: ./Cardoon/coverage
          flags: frontend-unittests
          name: cardoon-frontend-coverage
          fail_ci_if_error: false

  typecheck-backend:
    name: ğŸ“ Backend TypeScript Check
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./server

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "server/package-lock.json"

      - name: ğŸ“¦ Install backend dependencies
        run: npm ci

      - name: ğŸ“ Backend type check
        run: npx tsc --noEmit

  typecheck-frontend:
    name: ğŸ“ Frontend TypeScript Check
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./Cardoon

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: "Cardoon/yarn.lock"

      - name: ğŸ“¦ Install frontend dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ“ Frontend type check
        run: yarn type-check

  build-backend:
    name: ğŸ—ï¸ Backend Build Check
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./server

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "server/package-lock.json"

      - name: ğŸ“¦ Install backend dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build backend
        run: npm run build

      - name: ï¿½ Upload backend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: server-dist
          path: server/dist/
          retention-days: 7

  build-frontend:
    name: ğŸ—ï¸ Frontend Build Check
    runs-on: ubuntu-latest
    needs: [test-frontend, typecheck-frontend]

    defaults:
      run:
        working-directory: ./Cardoon

    steps:
      - name: ï¿½ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: "Cardoon/yarn.lock"

      - name: ğŸ“¦ Install frontend dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ—ï¸ Build frontend application
        run: yarn build

      - name: ğŸ“¤ Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: Cardoon/dist/
          retention-days: 7

  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Install root dependencies
        run: npm install

      - name: ğŸ“¦ Install backend dependencies
        run: npm run install-server

      - name: ğŸ“¦ Install frontend dependencies
        run: npm run install-client

      - name: ğŸ§ª Run all tests with coverage
        run: npm run test:coverage
